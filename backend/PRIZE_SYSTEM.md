# Система призов (Колесо фортуны)

## Описание

Система призов интегрирована в бэкенд 5LB. Призы хранятся в базе данных PostgreSQL через Prisma.

## Установка

1. **Создать миграцию Prisma:**
```bash
cd backend
npx prisma migrate dev --name add_prize_system
```

2. **Заполнить начальные данные призов:**
```bash
npx ts-node scripts/seed-prizes.ts
```

## API Endpoints

### POST /api/spin
Крутить колесо фортуны и получить приз.

**Ответ:**
```json
{
  "success": true,
  "prize": {
    "name": "1000 бонусов",
    "index": 0
  },
  "telegramLink": "https://t.me/pro_5lb_bot?start=abc123..."
}
```

### GET /api/prize/:hash
Получить информацию о призе по хешу (для Telegram бота).

**Ответ:**
```json
{
  "success": true,
  "prize": {
    "name": "1000 бонусов",
    "code": "bonus_1000"
  },
  "createdAt": "2025-01-XX..."
}
```

### GET /api/prizes
Получить список всех призов с вероятностями (для отладки).

**Ответ:**
```json
{
  "success": true,
  "prizes": [
    {
      "name": "1000 бонусов",
      "index": 0,
      "weight": 40,
      "probability": 40.00
    },
    ...
  ]
}
```

### GET /api/health
Health check endpoint.

## Telegram бот

Бот настроен на прием ссылок вида: `https://t.me/pro_5lb_bot?start=HASH`

При переходе по ссылке:
- Если пользователь зарегистрирован - в консоль выводится сообщение о начислении бонусов (пока без реальной реализации)
- Если пользователь не зарегистрирован - выводится сообщение о необходимости регистрации

## Структура БД

### Модель Prize
- `id` - уникальный идентификатор
- `name` - название приза (например, "1000 бонусов")
- `code` - код приза (например, "bonus_1000")
- `weight` - вес приза для вероятности выпадения
- `isActive` - активен ли приз

### Модель PrizeCode
- `id` - уникальный идентификатор
- `hash` - уникальный хеш для ссылки
- `prizeId` - связь с призом
- `prizeName` - название приза (дублируется для быстрого доступа)
- `prizeCode` - код приза (дублируется для быстрого доступа)
- `used` - использован ли код
- `usedAt` - дата использования
- `userId` - ID пользователя (если использован)

## Настройка призов

Призы настраиваются через скрипт `scripts/seed-prizes.ts`. По умолчанию создаются следующие призы:

- 1000 бонусов (вес: 40, вероятность: 40%)
- 3000 бонусов (вес: 25, вероятность: 25%)
- 5000 бонусов (вес: 20, вероятность: 20%)
- 7000 бонусов (вес: 10, вероятность: 10%)
- 10000 бонусов (вес: 5, вероятность: 5%)

## TODO

- [ ] Реализовать реальное начисление бонусов при использовании кода зарегистрированным пользователем
- [ ] Добавить возможность настройки призов через админ-панель
- [ ] Добавить лимиты на использование кодов (например, один код на пользователя)

