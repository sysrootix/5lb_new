#!/bin/bash
# ะกะบัะธะฟั ะฟัะพะฒะตัะบะธ ะฟะพัะปะต ะผะธะณัะฐัะธะธ 5LB
# ะะฐะฟััะบะฐัั ะฝะฐ ะะะะะ ัะตัะฒะตัะต ะฟะพัะปะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธั

echo "๐ ะัะพะฒะตัะบะฐ ัะฐะฑะพัะพัะฟะพัะพะฑะฝะพััะธ 5LB ะฟะพัะปะต ะผะธะณัะฐัะธะธ..."
echo ""

ERRORS=0
WARNINGS=0

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ะคัะฝะบัะธะธ ะดะปั ะฒัะฒะพะดะฐ
success() {
  echo -e "${GREEN}โ $1${NC}"
}

error() {
  echo -e "${RED}โ $1${NC}"
  ((ERRORS++))
}

warning() {
  echo -e "${YELLOW}โ๏ธ  $1${NC}"
  ((WARNINGS++))
}

info() {
  echo -e "โน๏ธ  $1"
}

# 1. ะัะพะฒะตัะบะฐ ัะธััะตะผะฝัั ัะปัะถะฑ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "1๏ธโฃ  ะัะพะฒะตัะบะฐ ัะธััะตะผะฝัั ัะปัะถะฑ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# PostgreSQL
if systemctl is-active --quiet postgresql; then
  success "PostgreSQL ะทะฐะฟััะตะฝ"
else
  error "PostgreSQL ะฝะต ะทะฐะฟััะตะฝ"
fi

# Nginx
if systemctl is-active --quiet nginx; then
  success "Nginx ะทะฐะฟััะตะฝ"
else
  warning "Nginx ะฝะต ะทะฐะฟััะตะฝ"
fi

echo ""

# 2. ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "2๏ธโฃ  ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั
if PGPASSWORD=MLwNXtCr8lGjab7vhA7UWKw1J2uePa psql -U lb_user -h localhost -d lb_db -c "SELECT 1" &>/dev/null; then
  success "ะะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั ัะฐะฑะพัะฐะตั"

  # ะัะพะฒะตัะบะฐ ัะฐะฑะปะธั
  USER_COUNT=$(PGPASSWORD=MLwNXtCr8lGjab7vhA7UWKw1J2uePa psql -U lb_user -h localhost -d lb_db -tAc 'SELECT COUNT(*) FROM "User"' 2>/dev/null || echo "0")
  if [ "$USER_COUNT" -gt 0 ]; then
    success "ะขะฐะฑะปะธัะฐ User ัะพะดะตัะถะธั $USER_COUNT ะทะฐะฟะธัะตะน"
  else
    error "ะขะฐะฑะปะธัะฐ User ะฟัััะฐั ะธะปะธ ะฝะต ัััะตััะฒัะตั"
  fi

  PRODUCT_COUNT=$(PGPASSWORD=MLwNXtCr8lGjab7vhA7UWKw1J2uePa psql -U lb_user -h localhost -d lb_db -tAc 'SELECT COUNT(*) FROM "Product"' 2>/dev/null || echo "0")
  if [ "$PRODUCT_COUNT" -gt 0 ]; then
    success "ะขะฐะฑะปะธัะฐ Product ัะพะดะตัะถะธั $PRODUCT_COUNT ะทะฐะฟะธัะตะน"
  else
    warning "ะขะฐะฑะปะธัะฐ Product ะฟัััะฐั ะธะปะธ ะฝะต ัััะตััะฒัะตั"
  fi

else
  error "ะะต ัะดะฐะปะพัั ะฟะพะดะบะปััะธัััั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั"
fi

echo ""

# 3. ะัะพะฒะตัะบะฐ PM2 ะฟัะพัะตััะพะฒ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "3๏ธโฃ  ะัะพะฒะตัะบะฐ PM2 ะฟัะพัะตััะพะฒ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if command -v pm2 &> /dev/null; then
  # ะัะพะฒะตัะบะฐ 5lb-backend
  if pm2 list | grep -q "5lb-backend.*online"; then
    success "5lb-backend ะทะฐะฟััะตะฝ"
  else
    error "5lb-backend ะฝะต ะทะฐะฟััะตะฝ ะธะปะธ ะฒ ััะฐัััะต stopped/errored"
  fi

  # ะัะพะฒะตัะบะฐ 5lb-crm-backend
  if pm2 list | grep -q "5lb-crm-backend.*online"; then
    success "5lb-crm-backend ะทะฐะฟััะตะฝ"
  else
    warning "5lb-crm-backend ะฝะต ะทะฐะฟััะตะฝ"
  fi

  # ะะพะบะฐะทะฐัั ัะฟะธัะพะบ ะฒัะตั ะฟัะพัะตััะพะฒ
  info "ะกะฟะธัะพะบ ะฒัะตั PM2 ะฟัะพัะตััะพะฒ:"
  pm2 list
else
  error "PM2 ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
fi

echo ""

# 4. ะัะพะฒะตัะบะฐ ัะฐะนะปะพะฒะพะน ััััะบัััั
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "4๏ธโฃ  ะัะพะฒะตัะบะฐ ัะฐะนะปะพะฒะพะน ััััะบัััั"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ะัะพะฒะตัะบะฐ ะพัะฝะพะฒะฝัั ะดะธัะตะบัะพัะธะน
if [ -d "/root/5lb" ]; then
  success "ะะธัะตะบัะพัะธั /root/5lb ัััะตััะฒัะตั"
else
  error "ะะธัะตะบัะพัะธั /root/5lb ะฝะต ะฝะฐะนะดะตะฝะฐ"
fi

if [ -d "/root/5lb/backend" ]; then
  success "ะะธัะตะบัะพัะธั backend ัััะตััะฒัะตั"
else
  error "ะะธัะตะบัะพัะธั backend ะฝะต ะฝะฐะนะดะตะฝะฐ"
fi

if [ -d "/root/5lb/frontend" ]; then
  success "ะะธัะตะบัะพัะธั frontend ัััะตััะฒัะตั"
else
  error "ะะธัะตะบัะพัะธั frontend ะฝะต ะฝะฐะนะดะตะฝะฐ"
fi

if [ -d "/root/5lb/crm" ]; then
  success "ะะธัะตะบัะพัะธั crm ัััะตััะฒัะตั"
else
  warning "ะะธัะตะบัะพัะธั crm ะฝะต ะฝะฐะนะดะตะฝะฐ"
fi

# ะัะพะฒะตัะบะฐ .env ัะฐะนะปะพะฒ
if [ -f "/root/5lb/backend/.env" ]; then
  success "backend/.env ัััะตััะฒัะตั"
else
  error "backend/.env ะฝะต ะฝะฐะนะดะตะฝ"
fi

if [ -f "/root/5lb/frontend/.env" ]; then
  success "frontend/.env ัััะตััะฒัะตั"
else
  warning "frontend/.env ะฝะต ะฝะฐะนะดะตะฝ"
fi

# ะัะพะฒะตัะบะฐ ัะพะฑัะฐะฝะฝัั ัะฐะนะปะพะฒ
if [ -f "/root/5lb/backend/dist/backend/src/index.js" ]; then
  success "Backend ัะพะฑัะฐะฝ (dist/backend/src/index.js)"
else
  error "Backend ะฝะต ัะพะฑัะฐะฝ"
fi

if [ -d "/root/5lb/frontend/dist" ] && [ "$(ls -A /root/5lb/frontend/dist)" ]; then
  success "Frontend ัะพะฑัะฐะฝ (dist/)"
else
  warning "Frontend ะฝะต ัะพะฑัะฐะฝ ะธะปะธ dist/ ะฟัััะฐั"
fi

echo ""

# 5. ะัะพะฒะตัะบะฐ ะฟะพััะพะฒ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "5๏ธโฃ  ะัะพะฒะตัะบะฐ ะฟะพััะพะฒ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ะะพัั 60000 (Backend) - ะฝะพะฒัะน ะฟะพัั
if netstat -tuln 2>/dev/null | grep -q ":60000 " || ss -tuln 2>/dev/null | grep -q ":60000 "; then
  success "ะะพัั 60000 (Backend) ะฟัะพัะปััะธะฒะฐะตััั"
else
  # ะัะพะฒะตััะตะผ ััะฐััะน ะฟะพัั 4000
  if netstat -tuln 2>/dev/null | grep -q ":4000 " || ss -tuln 2>/dev/null | grep -q ":4000 "; then
    warning "Backend ะธัะฟะพะปัะทัะตั ััะฐััะน ะฟะพัั 4000 (ะดะพะปะถะตะฝ ะฑััั 60000)"
  else
    error "Backend ะฝะต ะฟัะพัะปััะธะฒะฐะตััั ะฝะธ ะฝะฐ ะฟะพััั 60000, ะฝะธ ะฝะฐ 4000"
  fi
fi

# ะะพัั 60001 (CRM Backend) - ะฝะพะฒัะน ะฟะพัั
if netstat -tuln 2>/dev/null | grep -q ":60001 " || ss -tuln 2>/dev/null | grep -q ":60001 "; then
  success "ะะพัั 60001 (CRM Backend) ะฟัะพัะปััะธะฒะฐะตััั"
else
  # ะัะพะฒะตััะตะผ ััะฐััะน ะฟะพัั 5000
  if netstat -tuln 2>/dev/null | grep -q ":5000 " || ss -tuln 2>/dev/null | grep -q ":5000 "; then
    warning "CRM Backend ะธัะฟะพะปัะทัะตั ััะฐััะน ะฟะพัั 5000 (ะดะพะปะถะตะฝ ะฑััั 60001)"
  else
    warning "CRM Backend ะฝะต ะฟัะพัะปััะธะฒะฐะตััั ะฝะธ ะฝะฐ ะฟะพััั 60001, ะฝะธ ะฝะฐ 5000"
  fi
fi

# ะะพัั 80 (HTTP)
if netstat -tuln 2>/dev/null | grep -q ":80 " || ss -tuln 2>/dev/null | grep -q ":80 "; then
  success "ะะพัั 80 (HTTP) ะฟัะพัะปััะธะฒะฐะตััั"
else
  warning "ะะพัั 80 (HTTP) ะฝะต ะฟัะพัะปััะธะฒะฐะตััั"
fi

# ะะพัั 443 (HTTPS)
if netstat -tuln 2>/dev/null | grep -q ":443 " || ss -tuln 2>/dev/null | grep -q ":443 "; then
  success "ะะพัั 443 (HTTPS) ะฟัะพัะปััะธะฒะฐะตััั"
else
  warning "ะะพัั 443 (HTTPS) ะฝะต ะฟัะพัะปััะธะฒะฐะตััั (ะฒะพะทะผะพะถะฝะพ SSL ะฝะต ะฝะฐัััะพะตะฝ)"
fi

# ะะพัั 5432 (PostgreSQL)
if netstat -tuln 2>/dev/null | grep -q ":5432 " || ss -tuln 2>/dev/null | grep -q ":5432 "; then
  success "ะะพัั 5432 (PostgreSQL) ะฟัะพัะปััะธะฒะฐะตััั"
else
  error "ะะพัั 5432 (PostgreSQL) ะฝะต ะฟัะพัะปััะธะฒะฐะตััั"
fi

echo ""

# 6. ะัะพะฒะตัะบะฐ API
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "6๏ธโฃ  ะัะพะฒะตัะบะฐ API"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ะัะพะฒะตัะบะฐ localhost:60000 (ะฝะพะฒัะน ะฟะพัั)
if curl -s http://localhost:60000/api/health &>/dev/null; then
  success "API ะพัะฒะตัะฐะตั ะฝะฐ http://localhost:60000/api/health"
elif curl -s http://localhost:4000/api/health &>/dev/null; then
  warning "API ะพัะฒะตัะฐะตั ะฝะฐ ััะฐัะพะผ ะฟะพััั 4000 (ะดะพะปะถะตะฝ ะฑััั 60000)"
else
  error "API ะฝะต ะพัะฒะตัะฐะตั ะฝะธ ะฝะฐ ะฟะพััั 60000, ะฝะธ ะฝะฐ 4000"
fi

# ะัะพะฒะตัะบะฐ CRM API ะฝะฐ ะฟะพััั 60001
if curl -s http://localhost:60001/health &>/dev/null; then
  success "CRM API ะพัะฒะตัะฐะตั ะฝะฐ http://localhost:60001/health"
elif curl -s http://localhost:60001 &>/dev/null; then
  success "CRM API ะดะพัััะฟะตะฝ ะฝะฐ http://localhost:60001"
else
  warning "CRM API ะฝะต ะพัะฒะตัะฐะตั ะฝะฐ ะฟะพััั 60001 (ะฒะพะทะผะพะถะฝะพ ะฝะตั health endpoint)"
fi

# ะัะพะฒะตัะบะฐ ัะตัะตะท ะดะพะผะตะฝ (ะตัะปะธ Nginx ะฝะฐัััะพะตะฝ)
if command -v nginx &> /dev/null && systemctl is-active --quiet nginx; then
  DOMAIN=$(grep -r "server_name" /etc/nginx/sites-enabled/ 2>/dev/null | head -1 | awk '{print $NF}' | tr -d ';')
  if [ -n "$DOMAIN" ]; then
    info "ะัะพะฒะตัะบะฐ ะดะพะผะตะฝะฐ: $DOMAIN"
    if curl -s -o /dev/null -w "%{http_code}" "http://$DOMAIN" | grep -q "200\|301\|302"; then
      success "ะะพะผะตะฝ $DOMAIN ะพัะฒะตัะฐะตั"
    else
      warning "ะะพะผะตะฝ $DOMAIN ะฝะต ะพัะฒะตัะฐะตั (ะฒะพะทะผะพะถะฝะพ DNS ะตัะต ะฝะต ะพะฑะฝะพะฒะธะปัั)"
    fi
  fi
fi

echo ""

# 7. ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ ะฝะฐ ะพัะธะฑะบะธ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "7๏ธโฃ  ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ ะฝะฐ ะพัะธะฑะบะธ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# PM2 ะปะพะณะธ
if command -v pm2 &> /dev/null; then
  BACKEND_ERRORS=$(pm2 logs 5lb-backend --nostream --lines 100 2>/dev/null | grep -i "error" | wc -l)
  if [ "$BACKEND_ERRORS" -eq 0 ]; then
    success "Backend: ะพัะธะฑะพะบ ะฒ ะปะพะณะฐั ะฝะต ะฝะฐะนะดะตะฝะพ"
  else
    warning "Backend: ะฝะฐะนะดะตะฝะพ $BACKEND_ERRORS ะพัะธะฑะพะบ ะฒ ะฟะพัะปะตะดะฝะธั 100 ัััะพะบะฐั ะปะพะณะพะฒ"
    info "ะัะพะฒะตัััะต: pm2 logs 5lb-backend"
  fi
fi

# Nginx ะปะพะณะธ
if [ -f "/var/log/nginx/error.log" ]; then
  NGINX_ERRORS=$(tail -100 /var/log/nginx/error.log 2>/dev/null | grep -i "\[error\]" | wc -l)
  if [ "$NGINX_ERRORS" -eq 0 ]; then
    success "Nginx: ะพัะธะฑะพะบ ะฒ ะปะพะณะฐั ะฝะต ะฝะฐะนะดะตะฝะพ"
  else
    warning "Nginx: ะฝะฐะนะดะตะฝะพ $NGINX_ERRORS ะพัะธะฑะพะบ ะฒ ะฟะพัะปะตะดะฝะธั 100 ัััะพะบะฐั ะปะพะณะพะฒ"
    info "ะัะพะฒะตัััะต: tail -f /var/log/nginx/error.log"
  fi
fi

echo ""

# 8. ะัะพะณะพะฒัะน ะพััะตั
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ะัะพะณะพะฒัะน ะพััะตั"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
  echo -e "${GREEN}โจ ะัะปะธัะฝะพ! ะัะต ะฟัะพะฒะตัะบะธ ะฟัะพะนะดะตะฝั ััะฟะตัะฝะพ!${NC}"
  echo ""
  echo "โ ะกะธััะตะผะฐ ะฟะพะปะฝะพัััั ัะฐะฑะพัะพัะฟะพัะพะฑะฝะฐ"
  echo ""
  echo "๐ ะกะปะตะดัััะธะต ัะฐะณะธ:"
  echo "1. ะัะพะฒะตัััะต ััะฝะบัะธะพะฝะฐะปัะฝะพััั ะฒัััะฝัั (ะฐะฒัะพัะธะทะฐัะธั, ะบะฐัะฐะปะพะณ, ะบะพัะทะธะฝะฐ)"
  echo "2. ะะฑะฝะพะฒะธัะต DNS ะทะฐะฟะธัะธ ะฝะฐ ะฝะพะฒัะน IP ะฐะดัะตั"
  echo "3. ะะฐัััะพะนัะต SSL: certbot --nginx -d app.5lb.pro"
  echo "4. ะะฐัััะพะนัะต ะผะพะฝะธัะพัะธะฝะณ ะธ ัะตะทะตัะฒะฝะพะต ะบะพะฟะธัะพะฒะฐะฝะธะต"
  echo "5. ะะพัะปะต ััะฐะฑะธะปัะฝะพะน ัะฐะฑะพัั (2-3 ะดะฝั) ะผะพะถะฝะพ ะพัะบะปััะธัั ััะฐััะน ัะตัะฒะตั"
elif [ $ERRORS -eq 0 ]; then
  echo -e "${YELLOW}โ๏ธ  ะัะพะฒะตัะบะฐ ะทะฐะฒะตััะตะฝะฐ ั ะฟัะตะดัะฟัะตะถะดะตะฝะธัะผะธ${NC}"
  echo ""
  echo "ะัะตะดัะฟัะตะถะดะตะฝะธะน: $WARNINGS"
  echo ""
  echo "ะัะธัะธัะตัะบะธั ะพัะธะฑะพะบ ะฝะต ะพะฑะฝะฐััะถะตะฝะพ, ะฝะพ ะตััั ะฝะตะทะฝะฐัะธัะตะปัะฝัะต ะฟัะพะฑะปะตะผั."
  echo "ะกะธััะตะผะฐ ะผะพะถะตั ัะฐะฑะพัะฐัั, ะฝะพ ัะตะบะพะผะตะฝะดัะตััั ะธัะฟัะฐะฒะธัั ะฟัะตะดัะฟัะตะถะดะตะฝะธั."
else
  echo -e "${RED}โ ะะฑะฝะฐััะถะตะฝั ะบัะธัะธัะตัะบะธะต ะฟัะพะฑะปะตะผั!${NC}"
  echo ""
  echo "ะัะธะฑะพะบ: $ERRORS"
  echo "ะัะตะดัะฟัะตะถะดะตะฝะธะน: $WARNINGS"
  echo ""
  echo "ะะตะพะฑัะพะดะธะผะพ ะธัะฟัะฐะฒะธัั ะพัะธะฑะบะธ ะฟะตัะตะด ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ัะธััะตะผั!"
  echo ""
  echo "๐ ะะตะบะพะผะตะฝะดะฐัะธะธ:"
  echo "1. ะัะพะฒะตัััะต ะปะพะณะธ: pm2 logs"
  echo "2. ะัะพะฒะตัััะต ััะฐััั ัะตัะฒะธัะพะฒ: systemctl status postgresql nginx"
  echo "3. ะัะพะฒะตัััะต .env ัะฐะนะปั"
  echo "4. ะะฑัะฐัะธัะตัั ะบ MIGRATION-GUIDE.md ัะฐะทะดะตะป Troubleshooting"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะบะพะผะฐะฝะดั ะดะปั ะฟัะพะฒะตัะบะธ
echo "๐ง ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั ะดะปั ะดะธะฐะณะฝะพััะธะบะธ:"
echo ""
echo "  pm2 list                    - ัะฟะธัะพะบ ะฟัะพัะตััะพะฒ"
echo "  pm2 logs 5lb-backend        - ะปะพะณะธ backend"
echo "  pm2 logs 5lb-crm-backend    - ะปะพะณะธ CRM"
echo "  systemctl status postgresql - ััะฐััั ะะ"
echo "  systemctl status nginx      - ััะฐััั ะฒะตะฑ-ัะตัะฒะตัะฐ"
echo "  tail -f /var/log/nginx/error.log - ะปะพะณะธ Nginx"
echo "  psql -U lb_user -h localhost -d lb_db - ะฟะพะดะบะปััะตะฝะธะต ะบ ะะ"
echo ""
echo "๐ ะัะพะฒะตัะบะฐ ะฟะพััะพะฒ (ะฝะพะฒัะต: 60000-60010):"
echo ""
echo "  curl http://localhost:60000/api/health - ะฟัะพะฒะตัะบะฐ Backend API"
echo "  curl http://localhost:60001/health     - ะฟัะพะฒะตัะบะฐ CRM API"
echo "  netstat -tuln | grep 60000             - ะฟัะพะฒะตัะบะฐ ััะพ ะฟะพัั ะพัะบััั"
echo "  ss -tuln | grep 60001                  - ะฟัะพะฒะตัะบะฐ ััะพ ะฟะพัั ะพัะบััั"
echo ""

exit $ERRORS
