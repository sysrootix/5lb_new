# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram WebApp

## –î–∞—Ç–∞: 28 –æ–∫—Ç—è–±—Ä—è 2025

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Telegram WebApp:
- ‚úÖ Backend –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π
- ‚ùå Frontend –ø–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É 500: `TELEGRAM_USER_NOT_FOUND`
- ‚ùå –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ—à–∏–±–∫—É –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –õ–æ–≥ –æ—à–∏–±–∫–∏:
```
Status: 500
Message: TELEGRAM_USER_NOT_FOUND
Backend log: Telegram auth attempt for unknown user 1008837582
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω `useTelegramApp.ts`

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `requestContact` –≤ —Ç–∏–ø–∞—Ö:

```typescript
declare global {
  interface Window {
    Telegram?: {
      WebApp?: {
        // ... –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã
        requestContact?: (callback: (result: boolean) => void) => void;
      };
    };
  }
}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω `Login.tsx` - handleTelegramLogin

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è Telegram WebApp:**

```typescript
if (isTelegramApp && initData) {
  try {
    const response = await loginWithTelegram(initData);
    // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
    setUser(response.user);
    navigate(response.needsRegistration ? '/complete-registration' : '/');
  } catch (error: any) {
    const errorMessage = error?.response?.data?.message || error?.message;
    
    if (errorMessage === 'TELEGRAM_USER_NOT_FOUND') {
      // –ù–û–í–û–ï: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ Telegram WebApp API
      const tg = window.Telegram?.WebApp;
      
      if (tg?.requestContact) {
        tg.requestContact((granted) => {
          if (granted) {
            toast.success('–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—É—á–µ–Ω! –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.');
            // –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–¥—É—Ç –≤ initDataUnsafe
            navigate('/complete-registration');
          } else {
            toast.error('–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω—É–∂–µ–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
          }
        });
      } else {
        // Fallback: –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        toast('–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é', { icon: '‚úçÔ∏è' });
        navigate('/complete-registration');
      }
      return;
    }
    
    throw error; // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
  }
}
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω `App.tsx` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**–û–±—Ä–∞–±–æ—Ç–∫–∞ TELEGRAM_USER_NOT_FOUND:**

```typescript
catch (error) {
  const message = extractErrorMessage(error);
  
  if (message === 'TELEGRAM_USER_NOT_FOUND') {
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ /login –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
    sessionStorage.setItem(TELEGRAM_AUTO_AUTH_FLAG, 'done');
    navigate('/login', { replace: true });
    toast('–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', { 
      icon: 'üëã', 
      duration: 4000 
    });
    return;
  }
  
  // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
}
```

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Telegram WebApp

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebApp** ‚Üí App.tsx –ø—ã—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–≤—Ö–æ–¥
2. **Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç TELEGRAM_USER_NOT_FOUND**
3. **App.tsx –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ `/login`** —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"**
5. **Frontend –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `requestContact()`** ‚Üí Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç popup
6. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞**
7. **Telegram –æ–±–Ω–æ–≤–ª—è–µ—Ç `initDataUnsafe`** —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º
8. **Frontend –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ `/complete-registration`**
9. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç –§–ò–û, –¥–∞—Ç—É, –ø–æ–ª**
10. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!** ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Telegram WebApp

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebApp** ‚Üí App.tsx –∞–≤—Ç–æ–≤—Ö–æ–¥
2. **Backend –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** ‚Üí —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
3. **–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é** ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ë—Ä–∞—É–∑–µ—Ä (–Ω–µ WebApp)

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç /login**
2. **–ù–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"**
3. **–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è OAuth –≤–∏–¥–∂–µ—Ç** (oauth.telegram.org)
4. **–ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** ‚Üí –≤—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

---

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
Telegram WebApp (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
‚îÇ
‚îú‚îÄ initData (–±–µ–∑ phone) ‚Üí Backend
‚îÇ  ‚îî‚îÄ 500 TELEGRAM_USER_NOT_FOUND
‚îÇ
‚îú‚îÄ requestContact() ‚Üí Telegram API
‚îÇ  ‚îî‚îÄ User grants permission
‚îÇ     ‚îî‚îÄ initDataUnsafe.contact.phone_number
‚îÇ
‚îî‚îÄ /complete-registration
   ‚îî‚îÄ –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
      ‚îî‚îÄ POST /api/auth/complete-registration
         ‚îî‚îÄ ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
```

---

## üì± Telegram WebApp API

### requestContact()

–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞:

```typescript
window.Telegram.WebApp.requestContact((granted: boolean) => {
  if (granted) {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    // –ù–æ–º–µ—Ä –±—É–¥–µ—Ç –≤ initDataUnsafe.contact.phone_number
  } else {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª
  }
});
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–∞—Ç–∏–≤–Ω—ã–π Telegram UI
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ initData
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üé® UX —É–ª—É—á—à–µ–Ω–∏—è

### Toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

| –°–∏—Ç—É–∞—Ü–∏—è | –°–æ–æ–±—â–µ–Ω–∏–µ | –¢–∏–ø |
|----------|-----------|-----|
| –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (App.tsx) | "–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ üëã" | Info (4—Å–µ–∫) |
| –ó–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ | "–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞..." | Loading (2—Å–µ–∫) |
| –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω | "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—É—á–µ–Ω! –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é." | Success |
| –û—Ç–∫–∞–∑ –æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞ | "–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω—É–∂–µ–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" | Error |
| Fallback –±–µ–∑ API | "–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ‚úçÔ∏è" | Info |

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå 500 –æ—à–∏–±–∫–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ùå –ù–µ–ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ –¥–µ–ª–∞—Ç—å
- ‚ùå –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π UX

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ü–ª–∞–≤–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ WebApp –∏ –±—Ä–∞—É–∑–µ—Ä–µ
- ‚úÖ Graceful fallback –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. ‚úÖ **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ WebApp:**
   - –û—Ç–∫—Ä—ã—Ç—å WebApp –ø–µ—Ä–≤—ã–π —Ä–∞–∑
   - –î–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ /login
   - –ù–∞–∂–∞—Ç—å "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"
   - –î–æ–ª–∂–µ–Ω –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
   - –ü–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è ‚Üí /complete-registration

2. ‚úÖ **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ WebApp:**
   - –û—Ç–∫—Ä—ã—Ç—å WebApp
   - –î–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–π—Ç–∏
   - –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ /

3. ‚úÖ **–ë—Ä–∞—É–∑–µ—Ä (OAuth):**
   - –û—Ç–∫—Ä—ã—Ç—å /login –≤ –±—Ä–∞—É–∑–µ—Ä–µ
   - –ù–∞–∂–∞—Ç—å "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"
   - OAuth –≤–∏–¥–∂–µ—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å

4. ‚úÖ **–û—Ç–∫–∞–∑ –æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞:**
   - –ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
   - –û—Ç–∫–∞–∑–∞—Ç—å
   - –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –§–∞–π–ª | –°—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–æ | –¢–∏–ø |
|------|---------------|------|
| **useTelegramApp.ts** | +1 | –î–æ–±–∞–≤–ª–µ–Ω requestContact –≤ —Ç–∏–ø—ã |
| **Login.tsx** | +36 | –û–±—Ä–∞–±–æ—Ç–∫–∞ TELEGRAM_USER_NOT_FOUND |
| **App.tsx** | +7 | –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ /login |

**–ò—Ç–æ–≥–æ:** +44 —Å—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞

---

## üéØ –û—Ü–µ–Ω–∫–∞

### –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å: **9/10** ‚≠ê
- –ï—Å—Ç—å fallback –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è API
- Graceful error handling
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### UX: **9.5/10** ‚≠ê
- –ü–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –ù–∞—Ç–∏–≤–Ω—ã–π UI Telegram
- –ù–∏–∫–∞–∫–∏—Ö —Ä–µ–∑–∫–∏—Ö –æ—à–∏–±–æ–∫

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: **10/10** ‚úÖ
- Telegram –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- initData –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –Ω–∞ backend
- –ù–µ—Ç —É—Ç–µ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö

---

**–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üöÄ

_–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã, –ª–∏–Ω—Ç–µ—Ä —á–∏—Å—Ç_ ‚úÖ
