# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç–æ–≤ –Ω–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ (60000-60010)

## –û–±–∑–æ—Ä

–ù–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–æ—Ä—Ç—ã –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ **60000-60010** –≤–º–µ—Å—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤.

### –°—Ç–∞—Ä—ã–µ –ø–æ—Ä—Ç—ã (—Ç–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä):
- Backend: 4000
- CRM Backend: 5000

### –ù–æ–≤—ã–µ –ø–æ—Ä—Ç—ã (–Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä):
- **Backend: 60000**
- **CRM Backend: 60001**
- –†–µ–∑–µ—Ä–≤: 60002-60010 (–¥–ª—è –±—É–¥—É—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤)

---

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ `migration-restore.sh` –ø–æ—Ä—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**:

1. –°–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `migration-update-ports.sh`
3. –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
4. –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É

**–í–∞–º –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ!** –í—Å—ë –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç–æ–≤

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ—Ä—Ç—ã –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

```bash
cd /root/5lb
./migration-update-ports.sh
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:

1. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç `backend/.env` ‚Üí PORT=60000
2. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç `crm/crm_backend/.env` ‚Üí PORT=60001
3. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç `frontend/.env` ‚Üí API URLs —Å –Ω–æ–≤—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏
4. ‚úÖ –ó–∞–º–µ–Ω—è–µ—Ç `ecosystem.config.js` –Ω–∞ –≤–µ—Ä—Å–∏—é —Å –Ω–æ–≤—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏
5. ‚úÖ –°–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ç–æ–≤ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Nginx –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –Ω–æ–≤—ã–µ –ø–æ—Ä—Ç—ã.

### –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç —Ñ–∞–π–ª `nginx-new-ports.conf.example`:

```nginx
upstream backend {
    server localhost:60000;  # –ù–æ–≤—ã–π –ø–æ—Ä—Ç backend
}

upstream crm_backend {
    server localhost:60001;  # –ù–æ–≤—ã–π –ø–æ—Ä—Ç CRM
}

server {
    listen 80;
    server_name app.5lb.pro;

    # Frontend —Å—Ç–∞—Ç–∏–∫–∞
    location / {
        root /root/5lb/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # Backend API
    location /api {
        proxy_pass http://backend;
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ proxy
    }

    # CRM API
    location /crm-api {
        proxy_pass http://crm_backend;
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ proxy
    }
}
```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```bash
# 1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä –∫–∞–∫ –æ—Å–Ω–æ–≤—É
sudo cp /root/5lb/nginx-new-ports.conf.example /etc/nginx/sites-available/5lb.conf

# 2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
sudo nano /etc/nginx/sites-available/5lb.conf

# 3. –°–æ–∑–¥–∞–π—Ç–µ —Å–∏–º–ª–∏–Ω–∫
sudo ln -sf /etc/nginx/sites-available/5lb.conf /etc/nginx/sites-enabled/

# 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo nginx -t

# 5. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ Nginx
sudo systemctl reload nginx
```

---

## –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å –Ω–æ–≤—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ç–æ–≤ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```bash
cd /root/5lb

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pm2 delete all

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
pm2 start ecosystem.config.js

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
pm2 save

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
pm2 list
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ—Ä—Ç–æ–≤

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:

```bash
./migration-verify.sh
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç:
- ‚úÖ –ü–æ—Ä—Ç 60000 –æ—Ç–∫—Ä—ã—Ç –∏ —Å–ª—É—à–∞–µ—Ç
- ‚úÖ –ü–æ—Ä—Ç 60001 –æ—Ç–∫—Ä—ã—Ç –∏ —Å–ª—É—à–∞–µ—Ç
- ‚úÖ API –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –Ω–æ–≤—ã—Ö –ø–æ—Ä—Ç–∞—Ö
- ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞—Ä—ã–µ –ø–æ—Ä—Ç—ã

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ—Ä—Ç—ã —Å–ª—É—à–∞—é—Ç
netstat -tuln | grep 60000
netstat -tuln | grep 60001

# –ò–ª–∏ —Å –ø–æ–º–æ—â—å—é ss
ss -tuln | grep 60000
ss -tuln | grep 60001

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ API –æ—Ç–≤–µ—á–∞–µ—Ç
curl http://localhost:60000/api/health
curl http://localhost:60001/health
```

---

## –§–∞–π—Ä–≤–æ–ª

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ UFW –∏–ª–∏ iptables, –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–µ –ø–æ—Ä—Ç—ã:

```bash
# UFW
sudo ufw allow 60000/tcp comment 'Backend API'
sudo ufw allow 60001/tcp comment 'CRM Backend API'

# –ü—Ä–æ–≤–µ—Ä–∫–∞
sudo ufw status
```

**–í–∞–∂–Ω–æ:** –≠—Ç–∏ –ø–æ—Ä—Ç—ã –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞. –ò–∑–≤–Ω–µ –¥–æ—Å—Ç—É–ø –¥–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ Nginx (–ø–æ—Ä—Ç—ã 80/443).

---

## –û—Ç–∫–∞—Ç –Ω–∞ —Å—Ç–∞—Ä—ã–µ –ø–æ—Ä—Ç—ã

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä—ã–º –ø–æ—Ä—Ç–∞–º:

```bash
cd /root/5lb

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
cp ecosystem.config.old-server.js.backup ecosystem.config.js

# –í—Ä—É—á–Ω—É—é –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env —Ñ–∞–π–ª—ã
nano backend/.env              # PORT=4000
nano crm/crm_backend/.env      # PORT=5000

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
pm2 delete all
pm2 start ecosystem.config.js
pm2 save
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### Backend (.env)

```bash
grep "^PORT=" /root/5lb/backend/.env
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: PORT=60000
```

### CRM Backend (.env)

```bash
grep "^PORT=" /root/5lb/crm/crm_backend/.env
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: PORT=60001
```

### ecosystem.config.js

```bash
grep "PORT:" /root/5lb/ecosystem.config.js
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
#   PORT: 60000,
#   PORT: 60001
```

### Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```bash
grep "server localhost:" /etc/nginx/sites-enabled/5lb.conf
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
#   server localhost:60000;
#   server localhost:60001;
```

---

## Troubleshooting

### –ü–æ—Ä—Ç —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç
sudo lsof -i :60000
sudo lsof -i :60001

# –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
sudo kill -9 PID
```

### API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –Ω–æ–≤–æ–º –ø–æ—Ä—Ç—É

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ PM2
pm2 logs 5lb-backend

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω
pm2 list

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env —Ñ–∞–π–ª
cat /root/5lb/backend/.env | grep PORT

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
pm2 restart 5lb-backend
```

### Nginx –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 502 Bad Gateway

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ backend —Ä–∞–±–æ—Ç–∞–µ—Ç
curl http://localhost:60000/api/health

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
sudo nginx -t

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Nginx
sudo tail -f /var/log/nginx/error.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å upstream –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
grep -A5 "upstream backend" /etc/nginx/sites-enabled/5lb.conf
```

---

## –†–µ–∑—é–º–µ –∫–æ–º–∞–Ω–¥

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤
./migration-update-ports.sh

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –Ω–æ–≤—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏
pm2 delete all && pm2 start ecosystem.config.js && pm2 save

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ—Ä—Ç–æ–≤
./migration-verify.sh

# –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
curl http://localhost:60000/api/health
curl http://localhost:60001/health
netstat -tuln | grep -E "60000|60001"
```

---

## –ü–æ—á–µ–º—É –ø–æ—Ä—Ç—ã 60000-60010?

1. **–ù–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç** —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ (80, 443, 3000, 4000, 5000)
2. **–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω—ã** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
3. **–õ–µ–≥–∫–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å** - –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 600xx
4. **–ï—Å—Ç—å —Ä–µ–∑–µ—Ä–≤** –¥–ª—è –±—É–¥—É—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (60002-60010)
5. **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã** –æ—Ç –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

---

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ:**
- –ü–æ—Ä—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ `migration-restore.sh`
- –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å **–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx** –≤—Ä—É—á–Ω—É—é
- –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ç–æ–≤ **–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ PM2** –ø—Ä–æ—Ü–µ—Å—Å—ã
- **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ** —Ä–∞–±–æ—Ç—É —á–µ—Ä–µ–∑ `migration-verify.sh`

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ü–æ—Ä—Ç—ã 60000-60001 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ **–ª–æ–∫–∞–ª—å–Ω–æ**
- –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ **Nginx** (80/443)
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ **—Ñ–∞–π—Ä–≤–æ–ª** –ø—Ä–∞–≤–∏–ª—å–Ω–æ

üìù **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- –°—Ç–∞—Ä—ã–µ –ø–æ—Ä—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ `ecosystem.config.old-server.js.backup`
- –ü—Ä–∏–º–µ—Ä Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ `nginx-new-ports.conf.example`
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–æ–≤
